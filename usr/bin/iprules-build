#!/bin/bash

# This script builds the iptables rules file by generating
# a script that can be read by the iptables-restore command.
#
# It does this by dumping the policy file and the symlinked
# rules from the enabled directory into a file that is loaded
# by running iprules reload.

# Quit if not root
[[ "$UID" != 0 ]] && echo "Must be root." && exit 1;

source /etc/iprules.conf

# Overwrite the existing rules file with the front matter 
# and policy file contents
echo "# Generated by iprules $(date +"%Y-%m-%d %H:%M:%S")
*filter
$(cat $POLICY_FILE)
" > $RULES_FILE;

# Dump the enabled rules if there are any
if [ "$(ls $E_PATH|wc -l)" != "0" ]; then
  cat $E_PATH/* >> $RULES_FILE;
else
  echo "# no rules enabled" >> $RULES_FILE;
fi;

# Also need to do this to make it work
echo "COMMIT" >> $RULES_FILE;

echo "Rebuilt rules file.";
